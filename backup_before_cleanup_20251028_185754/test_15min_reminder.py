# test_15min_reminder.py
"""
ุงุฎุชุจุงุฑ ุงูุชุฐููุฑ ุงูุฌุฏูุฏ (15 ุฏูููุฉ ูุจู ุงูููุนุฏ)
"""

import sqlite3
from datetime import datetime, timedelta
from intelligent_agent import IntelligentAgent

def test_15min_reminder():
    """ุงุฎุชุจุงุฑ ุฅูุดุงุก ุชุฐููุฑ 15 ุฏูููุฉ"""
    print("="*60)
    print("๐ ุงุฎุชุจุงุฑ ุชุฐููุฑ ุงูู 15 ุฏูููุฉ")
    print("="*60)
    
    agent = IntelligentAgent()
    
    # ุญุฐู ุงูููุงุนูุฏ ุงูุชุฌุฑูุจูุฉ ุงููุฏููุฉ
    conn = sqlite3.connect(agent.db.db_path)
    cursor = conn.cursor()
    cursor.execute("DELETE FROM appointments WHERE user_id = 777")
    cursor.execute("DELETE FROM reminders WHERE appointment_id NOT IN (SELECT id FROM appointments)")
    conn.commit()
    conn.close()
    
    # ุณููุงุฑูููุงุช ุงุฎุชุจุงุฑ
    test_cases = [
        {
            'name': 'ููุนุฏ ุจุนุฏ 2 ุณุงุนุงุช',
            'time_delta': timedelta(hours=2),
            'expected_reminders': 2  # 1 ุณุงุนุฉ + 15 ุฏูููุฉ
        },
        {
            'name': 'ููุนุฏ ุจุนุฏ 30 ุณุงุนุฉ',
            'time_delta': timedelta(hours=30),
            'expected_reminders': 3  # 24 ุณุงุนุฉ + 1 ุณุงุนุฉ + 15 ุฏูููุฉ
        },
        {
            'name': 'ููุนุฏ ุจุนุฏ 30 ุฏูููุฉ',
            'time_delta': timedelta(minutes=30),
            'expected_reminders': 1  # 15 ุฏูููุฉ ููุท
        },
        {
            'name': 'ููุนุฏ ุจุนุฏ 10 ุฏูุงุฆู',
            'time_delta': timedelta(minutes=10),
            'expected_reminders': 0  # ูุง ุดูุก (ูุฑูุจ ุฌุฏุงู)
        }
    ]
    
    for test in test_cases:
        print(f"\n๐ {test['name']}:")
        print("-" * 60)
        
        future_time = datetime.now() + test['time_delta']
        
        # ุฅูุดุงุก ุงูููุนุฏ
        apt_id = agent.db.add_appointment(
            user_id=777,
            title=test['name'],
            description="ุงุฎุชุจุงุฑ ุงูุชุฐููุฑุงุช",
            date_time=future_time,
            priority=2
        )
        
        print(f"โ ุชู ุฅูุดุงุก ููุนุฏ #{apt_id}")
        print(f"   ๐ ุงูุชุงุฑูุฎ: {future_time.strftime('%Y-%m-%d %H:%M')}")
        
        # ูุญุต ุงูุชุฐููุฑุงุช ุงููููุดุฃุฉ
        conn = sqlite3.connect(agent.db.db_path)
        cursor = conn.cursor()
        
        cursor.execute('''
            SELECT id, reminder_time, 
                   (julianday(reminder_time) - julianday(?)) * 24 * 60 as minutes_before
            FROM reminders
            WHERE appointment_id = ?
            ORDER BY reminder_time
        ''', (future_time.strftime('%Y-%m-%d %H:%M:%S'), apt_id))
        
        reminders = cursor.fetchall()
        conn.close()
        
        print(f"   ๐ ุนุฏุฏ ุงูุชุฐููุฑุงุช: {len(reminders)}")
        
        if len(reminders) == test['expected_reminders']:
            print(f"   โ ุตุญูุญ! (ูุชููุน: {test['expected_reminders']})")
        else:
            print(f"   โ๏ธ ุบูุฑ ูุชููุน! (ูุชููุน: {test['expected_reminders']}, ุญุตููุง: {len(reminders)})")
        
        for reminder in reminders:
            rid, rtime, minutes = reminder
            rtime_dt = datetime.strptime(rtime, '%Y-%m-%d %H:%M:%S')
            
            # ุญุณุงุจ ุงููุฑู ุจุฏูุฉ
            time_diff = future_time - rtime_dt
            
            if time_diff.days > 0:
                diff_str = f"ูุจู {time_diff.days} ููู"
            elif time_diff.seconds >= 3600:
                hours = time_diff.seconds // 3600
                diff_str = f"ูุจู {hours} ุณุงุนุฉ"
            else:
                minutes = time_diff.seconds // 60
                diff_str = f"ูุจู {minutes} ุฏูููุฉ"
            
            print(f"      โข {rtime_dt.strftime('%Y-%m-%d %H:%M')} ({diff_str})")
    
    print("\n" + "="*60)


def show_reminder_schedule():
    """ุนุฑุถ ุฌุฏูู ุงูุชุฐููุฑุงุช ุงูุฌุฏูุฏ"""
    print("\n" + "="*60)
    print("๐ ุฌุฏูู ุงูุชุฐููุฑุงุช ุงูุฌุฏูุฏ")
    print("="*60)
    
    print("""
ุนูุฏ ุฅุถุงูุฉ ููุนุฏุ ูุชู ุฅูุดุงุก ุงูุชุฐููุฑุงุช ุงูุชุงููุฉ ุชููุงุฆูุงู:

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  ุงูููุช ูุจู ุงูููุนุฏ  โ  ุงูุชุฐููุฑ  โ  ุงูุญุงูุฉ          โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ  ๐ 24 ุณุงุนุฉ        โ  ุชุฐููุฑ 1  โ  ููููุงุนูุฏ ุงูุจุนูุฏุฉ โ
โ  โฐ 1 ุณุงุนุฉ         โ  ุชุฐููุฑ 2  โ  ููููุงุนูุฏ ุงูุจุนูุฏุฉ โ
โ  โฑ๏ธ  15 ุฏูููุฉ       โ  ุชุฐููุฑ 3  โ  ููููุงุนูุฏ ุงููุฑูุจุฉ โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

๐ ููุงุญุธุงุช:
โข ุงูุชุฐููุฑุงุช ุชููุดุฃ ููุท ุฅุฐุง ูุงู ุงูููุนุฏ ูู ุงููุณุชูุจู
โข ุฅุฐุง ูุงู ุงูููุนุฏ ุจุนุฏ 30 ุฏูููุฉ: ุชุฐููุฑ ูุงุญุฏ (15 ุฏูููุฉ ููุท)
โข ุฅุฐุง ูุงู ุงูููุนุฏ ุจุนุฏ 2 ุณุงุนุงุช: ุชุฐููุฑุงู (1 ุณุงุนุฉ + 15 ุฏูููุฉ)
โข ุฅุฐุง ูุงู ุงูููุนุฏ ุจุนุฏ 25 ุณุงุนุฉ: 3 ุชุฐููุฑุงุช (24 ุณุงุนุฉ + 1 ุณุงุนุฉ + 15 ุฏูููุฉ)
    """)
    
    print("="*60)


def compare_old_vs_new():
    """ููุงุฑูุฉ ุจูู ุงููุธุงู ุงููุฏูู ูุงูุฌุฏูุฏ"""
    print("\n" + "="*60)
    print("๐ ููุงุฑูุฉ: ุงููุธุงู ุงููุฏูู vs ุงูุฌุฏูุฏ")
    print("="*60)
    
    print("""
โโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโ
โ  ุงูููุนุฏ         โ  ุงููุธุงู ุงููุฏูู โ  ุงููุธุงู ุงูุฌุฏูุฏ  โ
โโโโโโโโโโโโโโโโโโโโผโโโโโโโโโโโโโโโโโโผโโโโโโโโโโโโโโโโโโโค
โ  ุจุนุฏ 30 ุณุงุนุฉ    โ  2 ุชุฐููุฑ       โ  3 ุชุฐููุฑ        โ
โ                  โ  (24h + 1h)     โ  (24h+1h+15min)  โ
โโโโโโโโโโโโโโโโโโโโผโโโโโโโโโโโโโโโโโโผโโโโโโโโโโโโโโโโโโโค
โ  ุจุนุฏ 2 ุณุงุนุงุช    โ  1 ุชุฐููุฑ       โ  2 ุชุฐููุฑ        โ
โ                  โ  (1h)           โ  (1h + 15min)    โ
โโโโโโโโโโโโโโโโโโโโผโโโโโโโโโโโโโโโโโโผโโโโโโโโโโโโโโโโโโโค
โ  ุจุนุฏ 30 ุฏูููุฉ   โ  0 ุชุฐููุฑ       โ  1 ุชุฐููุฑ        โ
โ                  โ  (ูุฑูุจ ุฌุฏุงู)    โ  (15min) โญ      โ
โโโโโโโโโโโโโโโโโโโโผโโโโโโโโโโโโโโโโโโผโโโโโโโโโโโโโโโโโโโค
โ  ุจุนุฏ 10 ุฏูุงุฆู   โ  0 ุชุฐููุฑ       โ  0 ุชุฐููุฑ        โ
โ                  โ  (ูุฑูุจ ุฌุฏุงู)    โ  (ูุฑูุจ ุฌุฏุงู)     โ
โโโโโโโโโโโโโโโโโโโโดโโโโโโโโโโโโโโโโโโดโโโโโโโโโโโโโโโโโโโ

โจ ุงููุงุฆุฏุฉ ุงูุฑุฆูุณูุฉ:
   ุงูุขู ุญุชู ุงูููุงุนูุฏ ุงููุฑูุจุฉ (20-60 ุฏูููุฉ) ุชุญุตู ุนูู ุชุฐููุฑ!
    """)
    
    print("="*60)


def practical_examples():
    """ุฃูุซูุฉ ุนูููุฉ"""
    print("\n" + "="*60)
    print("๐ก ุฃูุซูุฉ ุนูููุฉ")
    print("="*60)
    
    examples = [
        {
            'scenario': 'ููุนุฏ ูุน ุงูุทุจูุจ ุบุฏุงู ุงูุณุงุนุฉ 3 ูุณุงุกู',
            'reminders': [
                '๐ ุงูููู ุงูุณุงุนุฉ 3 ูุณุงุกู (ูุจู 24 ุณุงุนุฉ)',
                'โฐ ุบุฏุงู ุงูุณุงุนุฉ 2 ูุณุงุกู (ูุจู 1 ุณุงุนุฉ)',
                'โฑ๏ธ  ุบุฏุงู ุงูุณุงุนุฉ 2:45 ูุณุงุกู (ูุจู 15 ุฏูููุฉ)'
            ]
        },
        {
            'scenario': 'ุงุฌุชูุงุน ุงูููู ุจุนุฏ ุณุงุนุชูู',
            'reminders': [
                'โฐ ุจุนุฏ ุณุงุนุฉ ูุงุญุฏุฉ',
                'โฑ๏ธ  ุจุนุฏ ุณุงุนุฉ ู45 ุฏูููุฉ'
            ]
        },
        {
            'scenario': 'ููุนุฏ ุณุฑูุน ุจุนุฏ 40 ุฏูููุฉ',
            'reminders': [
                'โฑ๏ธ  ุจุนุฏ 25 ุฏูููุฉ (ูุจู 15 ุฏูููุฉ ูู ุงูููุนุฏ)'
            ]
        }
    ]
    
    for i, example in enumerate(examples, 1):
        print(f"\n{i}. {example['scenario']}")
        print("   ุงูุชุฐููุฑุงุช ุงูุชู ุณุชุตูู:")
        for reminder in example['reminders']:
            print(f"      {reminder}")
    
    print("\n" + "="*60)


if __name__ == "__main__":
    print("๐ ุงุฎุชุจุงุฑ ูุธุงู ุงูุชุฐููุฑุงุช ุงููุญุฏุซ (ูุน 15 ุฏูููุฉ)\n")
    
    # ุนุฑุถ ุงููุนูููุงุช
    show_reminder_schedule()
    compare_old_vs_new()
    practical_examples()
    
    # ุงูุงุฎุชุจุงุฑ ุงููุนูู
    test_15min_reminder()
    
    print("\nโ ุงูุชูู ุงูุงุฎุชุจุงุฑ!")
    print("""
๐ก ุงูุฎุทูุฉ ุงูุชุงููุฉ:
   ุฌุฑุจ ุนูู Telegram:
   
   "ููุนุฏ ุงูููู ุจุนุฏ 40 ุฏูููุฉ"
   
   ุณุชุญุตู ุนูู ุชุฐููุฑ ูุงุญุฏ ุจุนุฏ 25 ุฏูููุฉ! โฑ๏ธ
    """)