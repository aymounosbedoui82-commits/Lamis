#!/usr/bin/env python3
# fix_title_truncation.py
"""
ุฅุตูุงุญ ูุดููุฉ ูุทุน ุงูุนููุงู ูู ุงูุชุฐููุฑุงุช
ุงููุดููุฉ: ุงูุนููุงู ูุญุฏูุฏ ุจู 8 ูููุงุช ููุท
ุงูุญู: ุฅุฒุงูุฉ ุงูุญุฏ ุฃู ุฒูุงุฏุชู
"""

import os
import shutil
from datetime import datetime

def backup_file(filepath):
    """ุฅูุดุงุก ูุณุฎุฉ ุงุญุชูุงุทูุฉ"""
    if os.path.exists(filepath):
        timestamp = datetime.now().strftime('%Y%m%d_%H%M%S')
        backup_path = f"{filepath}.backup_{timestamp}"
        shutil.copy2(filepath, backup_path)
        print(f"โ ูุณุฎุฉ ุงุญุชูุงุทูุฉ: {backup_path}")
        return backup_path
    return None


def fix_intelligent_agent():
    """ุฅุตูุงุญ ููู intelligent_agent.py"""
    print("="*70)
    print("๐ง ุฅุตูุงุญ ูุดููุฉ ูุทุน ุงูุนููุงู")
    print("="*70)
    
    filepath = "intelligent_agent.py"
    
    if not os.path.exists(filepath):
        print(f"\nโ ุงูููู ุบูุฑ ููุฌูุฏ: {filepath}")
        return False
    
    # ุฅูุดุงุก ูุณุฎุฉ ุงุญุชูุงุทูุฉ
    print("\n1๏ธโฃ ุฅูุดุงุก ูุณุฎุฉ ุงุญุชูุงุทูุฉ...")
    backup_file(filepath)
    
    # ูุฑุงุกุฉ ุงูููู
    print("\n2๏ธโฃ ูุฑุงุกุฉ ุงูููู...")
    with open(filepath, 'r', encoding='utf-8') as f:
        content = f.read()
    
    # ุงูุจุญุซ ุนู ุงููุดููุฉ
    print("\n3๏ธโฃ ุงูุจุญุซ ุนู ุงููุดููุฉ...")
    
    old_code = """            title_words.append(word)
            
            # ุงูุญุฏ ุงูุฃูุตู: 8 ูููุงุช
            if len(title_words) >= 8:
                break"""
    
    # ุงูุญู 1: ุฅุฒุงูุฉ ุงูุญุฏ ุชูุงูุงู (ููุตู ุจู)
    new_code_unlimited = """            title_words.append(word)
            
            # โ ุชู ุฅุฒุงูุฉ ุญุฏ ุงููููุงุช - ุงูุนููุงู ุงููุงูู ุณูุธูุฑ"""
    
    # ุงูุญู 2: ุฒูุงุฏุฉ ุงูุญุฏ ุฅูู 20 ูููุฉ
    new_code_increased = """            title_words.append(word)
            
            # ุงูุญุฏ ุงูุฃูุตู: 20 ูููุฉ (ุจุฏูุงู ูู 8)
            if len(title_words) >= 20:
                break"""
    
    print("\n๐ ุงูุญููู ุงููุชุงุญุฉ:")
    print("โ"*70)
    print("1. ุฅุฒุงูุฉ ุงูุญุฏ ุชูุงูุงู (ููุตู ุจู) โจ")
    print("   โ ุงูุนููุงู ุงููุงูู ุณูุธูุฑ ุจุฏูู ูููุฏ")
    print("\n2. ุฒูุงุฏุฉ ุงูุญุฏ ุฅูู 20 ูููุฉ")
    print("   โ ูุณูุญ ุจุนูุงููู ุฃุทูู (ุญุชู 20 ูููุฉ)")
    print("โ"*70)
    
    choice = input("\nุงุฎุชุฑ ุงูุญู (1 ุฃู 2) [ุงูุชุฑุงุถู: 1]: ").strip() or "1"
    
    if choice == "1":
        new_code = new_code_unlimited
        solution = "ุฅุฒุงูุฉ ุงูุญุฏ ุชูุงูุงู"
    else:
        new_code = new_code_increased
        solution = "ุฒูุงุฏุฉ ุงูุญุฏ ุฅูู 20 ูููุฉ"
    
    print(f"\n4๏ธโฃ ุชุทุจูู ุงูุญู: {solution}...")
    
    if old_code in content:
        content = content.replace(old_code, new_code)
        print("   โ ุชู ุชุทุจูู ุงูุฅุตูุงุญ!")
    else:
        print("   โ๏ธ ูู ูุชู ุงูุนุซูุฑ ุนูู ุงูููุฏ ุงููุฏูู")
        print("   ุฑุจูุง ุชู ุชุทุจูู ุงูุฅุตูุงุญ ูุณุจูุงู")
        return False
    
    # ุญูุธ ุงูููู
    print("\n5๏ธโฃ ุญูุธ ุงูููู...")
    with open(filepath, 'w', encoding='utf-8') as f:
        f.write(content)
    print("   โ ุชู!")
    
    print("\n" + "="*70)
    print("โ ุชู ุงูุฅุตูุงุญ ุจูุฌุงุญ!")
    print("="*70)
    
    return True


def test_fix():
    """ุงุฎุชุจุงุฑ ุงูุฅุตูุงุญ"""
    print("\n" + "="*70)
    print("๐งช ุงุฎุชุจุงุฑ ุงูุฅุตูุงุญ")
    print("="*70)
    
    try:
        from intelligent_agent import IntelligentAgent
        
        agent = IntelligentAgent()
        
        # ุงุฎุชุจุงุฑ ุจุฑุณุงูุฉ ุทูููุฉ
        long_message = "ูุฏู ููุนุฏ ูุน ุตุฏููู ุงูููู ุจุนุฏ 20 ุฏูููุฉ ููููุงุด ุญูู ูุดุฑูุน ุฌุฏูุฏ ู ุฃูู ุงูุชุญุฏูุงุช ุงูุชู ูููู ุฃู ููุงุฌููุง"
        
        print(f"\n๐ ุงูุฑุณุงูุฉ ุงูุงุฎุชุจุงุฑูุฉ:")
        print(f"   {long_message}")
        
        language = agent.detect_language(long_message)
        title, description = agent._extract_title_and_description(long_message, language)
        
        print(f"\nโ ุงูุนููุงู ุงููุณุชุฎุฑุฌ:")
        print(f"   {title}")
        
        print(f"\n๐ ุนุฏุฏ ุงููููุงุช:")
        print(f"   ุงูุนููุงู: {len(title.split())} ูููุฉ")
        print(f"   ุงูุฑุณุงูุฉ ุงูุฃุตููุฉ: {len(long_message.split())} ูููุฉ")
        
        # ุงูุชุญูู ูู ุงููุฌุงุญ
        if len(title.split()) >= 10:
            print(f"\n๐ ููุชุงุฒ! ุงูุนููุงู ุงูุขู ูุญุชูู ุนูู ุฃูุซุฑ ูู 8 ูููุงุช")
            print(f"   ุงูุนููุงู ูุงูู: โ")
        else:
            print(f"\nโ๏ธ ุงูุนููุงู ูุง ูุฒุงู ูุตูุฑุงู")
        
        return True
        
    except Exception as e:
        print(f"\nโ ุฎุทุฃ ูู ุงูุงุฎุชุจุงุฑ: {e}")
        import traceback
        traceback.print_exc()
        return False


def show_example():
    """ุนุฑุถ ูุซุงู ุนูู ุงูุชุฐููุฑ ุจุนุฏ ุงูุฅุตูุงุญ"""
    print("\n" + "="*70)
    print("๐ฑ ูุซุงู ุนูู ุงูุชุฐููุฑ ุจุนุฏ ุงูุฅุตูุงุญ")
    print("="*70)
    
    print("""
๐จ ูุจู ุงูุฅุตูุงุญ (ููุทูุน):
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โฐ ุชุฐููุฑ ุจููุนุฏ | Rappel | Reminder:

๐ ููุนุฏ ูุน ุตุฏููู ููููุงุด ุญูู ูุดุฑูุน ุฌุฏูุฏ ู  โ
๐ 2025-10-27 18:54:02

๐ ูุง ุชูุณู ููุนุฏู!


๐จ ุจุนุฏ ุงูุฅุตูุงุญ (ูุงูู):
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โฐ ุชุฐููุฑ ุจููุนุฏ | Rappel | Reminder:

๐ ููุนุฏ ูุน ุตุฏููู ููููุงุด ุญูู ูุดุฑูุน ุฌุฏูุฏ ู ุฃูู ุงูุชุญุฏูุงุช ุงูุชู ูููู ุฃู ููุงุฌููุง  โ
๐ 2025-10-27 18:54:02

๐ ูุง ุชูุณู ููุนุฏู!
    """)
    
    print("="*70)


def main():
    """ุงูุจุฑูุงูุฌ ุงูุฑุฆูุณู"""
    print("\n๐ ุฃุฏุงุฉ ุฅุตูุงุญ ูุดููุฉ ูุทุน ุงูุนููุงู ูู ุงูุชุฐููุฑุงุช\n")
    
    # ุนุฑุถ ุงููุซุงู
    show_example()
    
    # ุณุคุงู ุงููุณุชุฎุฏู
    print("\nโ ูู ุชุฑูุฏ ุชุทุจูู ุงูุฅุตูุงุญุ (y/n): ", end='')
    response = input().lower()
    
    if response != 'y':
        print("\nโ ุชู ุงูุฅูุบุงุก")
        return
    
    # ุชุทุจูู ุงูุฅุตูุงุญ
    if fix_intelligent_agent():
        # ุงุฎุชุจุงุฑ
        test_fix()
        
        print("\n" + "="*70)
        print("๐ก ุงูุฎุทูุงุช ุงูุชุงููุฉ:")
        print("="*70)
        print("""
1. โ ุชู ุฅุตูุงุญ ุงููุดููุฉ!

2. ๐ ุฃุนุฏ ุชุดุบูู ุงูุจูุช:
   python telegram_bot.py
   
3. ๐งช ุฌุฑุจ ุฅุถุงูุฉ ููุนุฏ ุจุฑุณุงูุฉ ุทูููุฉ:
   "ูุฏู ููุนุฏ ูุน ุตุฏููู ุงูููู ุจุนุฏ 30 ุฏูููุฉ ููููุงุด ุญูู ูุดุฑูุน ุฌุฏูุฏ ู ุฃูู ุงูุชุญุฏูุงุช ุงูุชู ูููู ุฃู ููุงุฌููุง"

4. ๐ฑ ุงูุชุธุฑ ุงูุชุฐููุฑ - ุณูุธูุฑ ุงูุนููุงู ูุงููุงู!

๐ก ููุงุญุธุฉ:
   โข ุงูููุงุนูุฏ ุงููุฏููุฉ: ุงูุนููุงู ูุจูู ููุง ูู (ููุทูุน)
   โข ุงูููุงุนูุฏ ุงูุฌุฏูุฏุฉ: ุงูุนููุงู ุณูููู ูุงููุงู โ
        """)
    else:
        print("\nโ ูุดู ุชุทุจูู ุงูุฅุตูุงุญ")


if __name__ == "__main__":
    try:
        main()
    except KeyboardInterrupt:
        print("\n\n๐ ุชู ุงูุฅูุบุงุก")
    except Exception as e:
        print(f"\nโ ุฎุทุฃ: {e}")
        import traceback
        traceback.print_exc()