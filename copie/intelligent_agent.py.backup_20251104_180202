# intelligent_agent.py
"""
Ø§Ù„ÙˆÙƒÙŠÙ„ Ø§Ù„Ø°ÙƒÙŠ Ø§Ù„Ù…ØªØ·ÙˆØ± - Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ© âœ¨
ÙŠØ¯Ø¹Ù…:
- 3 Ù„ØºØ§Øª (Ø¹Ø±Ø¨ÙŠ ÙØµØ­Ù‰ + ØªÙˆÙ†Ø³ÙŠØŒ ÙØ±Ù†Ø³ÙŠØŒ Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ)
- Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ø°ÙƒÙŠ ÙˆØ§Ù„Ø¯Ù‚ÙŠÙ‚
- Ø¹Ù†ÙˆØ§Ù† Ù…Ø®ØªØµØ± ÙˆÙˆØµÙ Ù…Ù†ÙØµÙ„
- Ù†Ø¸Ø§Ù… ØªØ°ÙƒÙŠØ±Ø§Øª Ù…ØªØ·ÙˆØ± (4 ØªØ°ÙƒÙŠØ±Ø§Øª)
- Ø¹Ø±Ø¶ Ù…ÙˆØ§Ø¹ÙŠØ¯ ÙŠÙˆÙ… Ù…Ø­Ø¯Ø¯
"""

import re
import sqlite3
from datetime import datetime, timedelta
from typing import Optional, Dict, List, Tuple
import logging

# ==========================================
# Ø§Ù„Ù…Ø±Ø­Ù„Ø© 2: ØªØ­Ø³ÙŠÙ†Ø§Øª Ø§Ù„Ø£Ø¯Ø§Ø¡ âœ…
# ==========================================
from database_pool import get_pool, DatabaseConnectionPool
from cache_manager import appointment_cache, cached
from advanced_features import (
    CustomReminderManager,
    RecurringAppointmentManager,
    MonthlyCalendar,
    AppointmentExportImport
)
from analytics_dashboard import AnalyticsDashboard

# Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø³Ø¬Ù„Ø§Øª
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)


class Database:
    """Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª"""
    
    def __init__(self, db_path="agent_data.db"):
        self.db_path = db_path
        self.init_database()
    
    def init_database(self):
        """Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„"""
        conn = sqlite3.connect(self.db_path)
        cursor = conn.cursor()
        
        # Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯
        cursor.execute('''
            CREATE TABLE IF NOT EXISTS appointments (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                user_id INTEGER NOT NULL,
                title TEXT NOT NULL,
                description TEXT,
                date_time TEXT NOT NULL,
                priority INTEGER DEFAULT 2,
                created_at TEXT DEFAULT CURRENT_TIMESTAMP
            )
        ''')
        
        # Ø¬Ø¯ÙˆÙ„ Ø§Ù„ØªØ°ÙƒÙŠØ±Ø§Øª
        cursor.execute('''
            CREATE TABLE IF NOT EXISTS reminders (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                appointment_id INTEGER NOT NULL,
                reminder_time TEXT NOT NULL,
                sent INTEGER DEFAULT 0,
                custom_message TEXT,
                FOREIGN KEY (appointment_id) REFERENCES appointments (id)
            )
        ''')
        
        # Ø¬Ø¯ÙˆÙ„ Ø§Ù„ØªÙØ§Ø¹Ù„Ø§Øª
        cursor.execute('''
            CREATE TABLE IF NOT EXISTS interactions (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                user_id INTEGER NOT NULL,
                user_message TEXT NOT NULL,
                bot_response TEXT NOT NULL,
                intent TEXT,
                language TEXT,
                timestamp TEXT DEFAULT CURRENT_TIMESTAMP,
                feedback INTEGER DEFAULT 0
            )
        ''')
        
        conn.commit()
        conn.close()
    
    def add_appointment(self, user_id: int, title: str, description: str, 
                       date_time: datetime, priority: int = 2) -> int:
        """Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ¹Ø¯ Ø¬Ø¯ÙŠØ¯ Ù…Ø¹ Ø§Ù„ØªØ°ÙƒÙŠØ±Ø§Øª Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØ©"""
        conn = sqlite3.connect(self.db_path)
        cursor = conn.cursor()
        
        # Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…ÙˆØ¹Ø¯
        cursor.execute('''
            INSERT INTO appointments (user_id, title, description, date_time, priority)
            VALUES (?, ?, ?, ?, ?)
        ''', (user_id, title, description, date_time.strftime('%Y-%m-%d %H:%M:%S'), priority))
        
        appointment_id = cursor.lastrowid
        
        # Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªØ°ÙƒÙŠØ±Ø§Øª ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
        now = datetime.now()
        time_until = date_time - now
        
        reminders_created = 0
        
        # ØªØ°ÙƒÙŠØ± Ù‚Ø¨Ù„ 24 Ø³Ø§Ø¹Ø©
        if time_until > timedelta(hours=24):
            reminder_time = date_time - timedelta(hours=24)
            if reminder_time > now:
                cursor.execute('''
                    INSERT INTO reminders (appointment_id, reminder_time, custom_message)
                    VALUES (?, ?, ?)
                ''', (appointment_id, reminder_time.strftime('%Y-%m-%d %H:%M:%S'), 'type:advance'))
                reminders_created += 1
        
        # ØªØ°ÙƒÙŠØ± Ù‚Ø¨Ù„ 1 Ø³Ø§Ø¹Ø©
        if time_until > timedelta(hours=1):
            reminder_time = date_time - timedelta(hours=1)
            if reminder_time > now:
                cursor.execute('''
                    INSERT INTO reminders (appointment_id, reminder_time, custom_message)
                    VALUES (?, ?, ?)
                ''', (appointment_id, reminder_time.strftime('%Y-%m-%d %H:%M:%S'), 'type:advance'))
                reminders_created += 1
        
        # ØªØ°ÙƒÙŠØ± Ù‚Ø¨Ù„ 15 Ø¯Ù‚ÙŠÙ‚Ø©
        if time_until > timedelta(minutes=15):
            reminder_time = date_time - timedelta(minutes=15)
            if reminder_time > now:
                cursor.execute('''
                    INSERT INTO reminders (appointment_id, reminder_time, custom_message)
                    VALUES (?, ?, ?)
                ''', (appointment_id, reminder_time.strftime('%Y-%m-%d %H:%M:%S'), 'type:advance'))
                reminders_created += 1
        
        # ØªØ°ÙƒÙŠØ± Ø¹Ù†Ø¯ Ø§Ù„Ù…ÙˆØ¹Ø¯
        if time_until > timedelta(minutes=0):
            cursor.execute('''
                INSERT INTO reminders (appointment_id, reminder_time, custom_message)
                VALUES (?, ?, ?)
            ''', (appointment_id, date_time.strftime('%Y-%m-%d %H:%M:%S'), 'type:now'))
            reminders_created += 1
        
        conn.commit()
        conn.close()
        
        logger.info(f"âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù…ÙˆØ¹Ø¯ #{appointment_id} Ù…Ø¹ {reminders_created} ØªØ°ÙƒÙŠØ±")
        
        return appointment_id
    
    def get_appointments(self, user_id: int, start_date: str = None, 
                        end_date: str = None) -> List[Dict]:
        """Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯"""
        conn = sqlite3.connect(self.db_path)
        cursor = conn.cursor()
        
        if start_date and end_date:
            cursor.execute('''
                SELECT id, title, description, date_time, priority
                FROM appointments
                WHERE user_id = ? AND date_time BETWEEN ? AND ?
                ORDER BY date_time ASC
            ''', (user_id, start_date, end_date))
        else:
            cursor.execute('''
                SELECT id, title, description, date_time, priority
                FROM appointments
                WHERE user_id = ?
                ORDER BY date_time ASC
            ''', (user_id,))
        
        appointments = []
        for row in cursor.fetchall():
            appointments.append({
                'id': row[0],
                'title': row[1],
                'description': row[2],
                'date_time': row[3],
                'priority': row[4]
            })
        
        conn.close()
        return appointments
    
    def log_interaction(self, user_id: int, user_message: str, 
                       bot_response: str, intent: str, language: str):
        """ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØªÙØ§Ø¹Ù„"""
        conn = sqlite3.connect(self.db_path)
        cursor = conn.cursor()
        
        cursor.execute('''
            INSERT INTO interactions (user_id, user_message, bot_response, intent, language)
            VALUES (?, ?, ?, ?, ?)
        ''', (user_id, user_message, bot_response, intent, language))
        
        conn.commit()
        conn.close()


class IntelligentAgent:
    """Ø§Ù„ÙˆÙƒÙŠÙ„ Ø§Ù„Ø°ÙƒÙŠ - Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù…Ø­Ø³Ù‘Ù†Ø©"""
    
    def __init__(self, db_path="agent_data.db"):
        self.db = Database(db_path)
        self.intent_labels = [
            'add_appointment', 'list_appointments', 'check_specific_day',
            'delete_appointment', 'update_appointment', 
            'greeting', 'thanks', 'help', 'unknown'
        ]
    
    def detect_language(self, text: str) -> str:
        """ÙƒØ´Ù Ø§Ù„Ù„ØºØ©"""
        # Ø¹Ø±Ø¨ÙŠ
        if re.search(r'[\u0600-\u06FF]', text):
            return 'ar'
        # ÙØ±Ù†Ø³ÙŠ
        elif any(word in text.lower() for word in ['bonjour', 'rendez-vous', 'rdv', 'merci', 'demain', 'aujourd']):
            return 'fr'
        # Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ (Ø§ÙØªØ±Ø§Ø¶ÙŠ)
        else:
            return 'en'
    
    def classify_intent(self, message: str) -> str:
        """ØªØµÙ†ÙŠÙ Ø§Ù„Ù†ÙŠØ© - Ù…Ø­Ø³Ù‘Ù†"""
        message_lower = message.lower()
        
        # Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ¹Ø¯
        add_keywords = {
            'ar': ['Ù…ÙˆØ¹Ø¯', 'Ø§Ø¬ØªÙ…Ø§Ø¹', 'Ù„Ù‚Ø§Ø¡', 'Ù…Ù‚Ø§Ø¨Ù„Ø©', 'Ø£Ø¶Ù', 'Ø³Ø¬Ù„'],
            'fr': ['rdv', 'rendez-vous', 'rÃ©union', 'rencontre', 'ajouter'],
            'en': ['appointment', 'meeting', 'schedule', 'book', 'add']
        }
        
        for lang, keywords in add_keywords.items():
            if any(kw in message_lower for kw in keywords):
                # ØªØ­Ù‚Ù‚: Ù„ÙŠØ³ Ø·Ù„Ø¨ Ø¹Ø±Ø¶ Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯
                view_keywords = ['Ù…ÙˆØ§Ø¹ÙŠØ¯ÙŠ', 'Ù…ÙˆØ§Ø¹ÙŠØ¯Ùƒ', 'Ø¹Ø±Ø¶', 'Ø£Ø¸Ù‡Ø±', 'mes rendez-vous', 'mes rdv', 'my appointments']
                if not any(vkw in message_lower for vkw in view_keywords):
                    return 'add_appointment'
        
        # Ø¹Ø±Ø¶ Ù…ÙˆØ§Ø¹ÙŠØ¯ ÙŠÙˆÙ… Ù…Ø­Ø¯Ø¯
        specific_day_patterns = [
            # Ø¹Ø±Ø¨ÙŠ
            'Ù…ÙˆØ§Ø¹ÙŠØ¯ÙŠ Ø§Ù„ÙŠÙˆÙ…', 'Ù…ÙˆØ§Ø¹ÙŠØ¯ÙŠ ØºØ¯Ø§', 'Ù…ÙˆØ§Ø¹ÙŠØ¯ÙŠ ØºØ¯Ø§Ù‹',
            'Ù…Ø§ Ù‡ÙŠ Ù…ÙˆØ§Ø¹ÙŠØ¯ÙŠ', 'Ù…ÙˆØ§Ø¹ÙŠØ¯ÙŠ ÙŠÙˆÙ…',
            # ÙØ±Ù†Ø³ÙŠ
            'mes rendez-vous aujourd', 'mes rdv demain', 'mes rendez-vous le',
            'quels sont mes rendez-vous', 'mes rdv le',
            # Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ
            'my appointments today', 'appointments tomorrow',
            'what are my appointments', 'my appointments on'
        ]
        
        if any(pattern in message_lower for pattern in specific_day_patterns):
            return 'check_specific_day'
        
        # Ø¹Ø±Ø¶ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯ - Ù…Ø­Ø³Ù‘Ù† âœ…
        list_keywords = {
            'ar': [
                'Ø¹Ø±Ø¶ Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯', 'Ø£Ø¸Ù‡Ø± Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯', 'Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯',
                'Ø¹Ø±Ø¶ Ù…ÙˆØ§Ø¹ÙŠØ¯ÙŠ', 'Ø§Ø¹Ø±Ø¶ Ù…ÙˆØ§Ø¹ÙŠØ¯ÙŠ', 'Ø´ÙˆÙ Ù…ÙˆØ§Ø¹ÙŠØ¯ÙŠ',
                'Ù…ÙˆØ§Ø¹ÙŠØ¯ÙŠ', 'ÙƒÙ„ Ù…ÙˆØ§Ø¹ÙŠØ¯ÙŠ', 'Ø´Ù†ÙˆØ§ Ù…ÙˆØ§Ø¹ÙŠØ¯ÙŠ'
            ],
            'fr': [
                'afficher', 'montrer', 'tous les rendez-vous',
                'mes rendez-vous', 'mes rdv', 'voir mes rdv'
            ],
            'en': [
                'show all', 'display all', 'list all',
                'show my appointments', 'my appointments', 'all appointments'
            ]
        }
        
        for lang, keywords in list_keywords.items():
            if any(kw in message_lower for kw in keywords):
                return 'list_appointments'
        
        # ØªØ­ÙŠØ©
        greeting_keywords = ['Ù…Ø±Ø­Ø¨Ø§', 'Ø§Ù„Ø³Ù„Ø§Ù…', 'ØµØ¨Ø§Ø­', 'Ù…Ø³Ø§Ø¡', 'bonjour', 'salut', 'hello', 'hi', 'hey']
        if any(kw in message_lower for kw in greeting_keywords):
            return 'greeting'
        
        # Ø´ÙƒØ±
        thanks_keywords = ['Ø´ÙƒØ±Ø§', 'Ø´ÙƒØ±Ø§Ù‹', 'Ù…Ø´ÙƒÙˆØ±', 'merci', 'thanks', 'thank you']
        if any(kw in message_lower for kw in thanks_keywords):
            return 'thanks'
        
        # Ù…Ø³Ø§Ø¹Ø¯Ø©
        help_keywords = ['Ù…Ø³Ø§Ø¹Ø¯Ø©', 'Ø³Ø§Ø¹Ø¯Ù†ÙŠ', 'ÙƒÙŠÙ', 'aide', 'help']
        if any(kw in message_lower for kw in help_keywords):
            return 'help'
        
        return 'unknown'
    
    def extract_datetime(self, text: str, language: str) -> datetime:
        """Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„ÙˆÙ‚Øª Ù…Ù† Ø§Ù„Ù†Øµ - Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ© âœ¨"""
        text_lower = text.lower()
        now = datetime.now()
        
        # ==========================================
        # Ø£ÙˆÙ„Ø§Ù‹: Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† ØªØ§Ø±ÙŠØ® Ø±Ù‚Ù…ÙŠ ØµØ±ÙŠØ­ (Ù„Ù‡ Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ©!)
        # ==========================================
        
        # Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ø´Ù‡ÙˆØ± (Ù…Ø¹ Ø¯Ø¹Ù… Ø§Ù„Ù„Ù‡Ø¬Ø© Ø§Ù„ØªÙˆÙ†Ø³ÙŠØ©/Ø§Ù„Ù…ØºØ§Ø±Ø¨ÙŠØ©)
        month_names_ar = {
            'ÙŠÙ†Ø§ÙŠØ±': 1, 'Ø¬Ø§Ù†ÙÙŠ': 1,
            'ÙØ¨Ø±Ø§ÙŠØ±': 2, 'ÙÙŠÙØ±ÙŠ': 2,
            'Ù…Ø§Ø±Ø³': 3,
            'Ø£Ø¨Ø±ÙŠÙ„': 4, 'Ø£ÙØ±ÙŠÙ„': 4,
            'Ù…Ø§ÙŠÙˆ': 5, 'Ù…Ø§ÙŠ': 5,
            'ÙŠÙˆÙ†ÙŠÙˆ': 6, 'Ø¬ÙˆØ§Ù†': 6,
            'ÙŠÙˆÙ„ÙŠÙˆ': 7, 'Ø¬ÙˆÙŠÙ„ÙŠØ©': 7,
            'Ø£ØºØ³Ø·Ø³': 8, 'Ø£ÙˆØª': 8,
            'Ø³Ø¨ØªÙ…Ø¨Ø±': 9, 'Ø´ØªÙ†Ø¨Ø±': 9,
            'Ø£ÙƒØªÙˆØ¨Ø±': 10, 'ÙƒØªÙˆØ¨Ø±': 10,
            'Ù†ÙˆÙÙ…Ø¨Ø±': 11, 'Ù†ÙˆÙ†Ø¨Ø±': 11,
            'Ø¯ÙŠØ³Ù…Ø¨Ø±': 12, 'Ø¯Ø¬Ù†Ø¨Ø±': 12
        }
        
        month_names_fr = {
            'janvier': 1, 'fÃ©vrier': 2, 'fevrier': 2, 'mars': 3, 'avril': 4,
            'mai': 5, 'juin': 6, 'juillet': 7, 'aoÃ»t': 8, 'aout': 8,
            'septembre': 9, 'octobre': 10, 'novembre': 11, 'dÃ©cembre': 12, 'decembre': 12
        }
        
        month_names_en = {
            'january': 1, 'jan': 1, 'february': 2, 'feb': 2, 'march': 3, 'mar': 3,
            'april': 4, 'apr': 4, 'may': 5, 'june': 6, 'jun': 6,
            'july': 7, 'jul': 7, 'august': 8, 'aug': 8,
            'september': 9, 'sep': 9, 'october': 10, 'oct': 10,
            'november': 11, 'nov': 11, 'december': 12, 'dec': 12
        }
        
        # Ø¯Ù…Ø¬ ÙƒÙ„ Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ø´Ù‡ÙˆØ±
        all_months = {**month_names_ar, **month_names_fr, **month_names_en}
        
        # Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ù†Ù…Ø·: "DD Ø§Ø³Ù…_Ø§Ù„Ø´Ù‡Ø± YYYY"
        for month_name, month_num in all_months.items():
            pattern = rf'(\d{{1,2}})\s+{month_name}(?:\s+(\d{{4}}))?'
            match = re.search(pattern, text_lower)
            if match:
                day = int(match.group(1))
                year = int(match.group(2)) if match.group(2) else now.year
                
                try:
                    date = datetime(year, month_num, day)
                    logger.info(f"âœ… Ø§Ø³ØªØ®Ø±Ø§Ø¬ ØªØ§Ø±ÙŠØ® ØµØ±ÙŠØ­: {date.strftime('%Y-%m-%d')}")
                    
                    # Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„ÙˆÙ‚Øª
                    time_tuple = self._extract_time(text)
                    if time_tuple:
                        date = date.replace(hour=time_tuple[0], minute=time_tuple[1])
                    else:
                        date = date.replace(hour=9, minute=0)
                    
                    return date
                except ValueError:
                    logger.warning(f"ØªØ§Ø±ÙŠØ® ØºÙŠØ± ØµØ§Ù„Ø­: {day}/{month_num}/{year}")
                    pass
        
        # Ù†Ù…Ø· DD/MM/YYYY Ø£Ùˆ DD-MM-YYYY
        date_match = re.search(r'(\d{1,2})[/-](\d{1,2})[/-](\d{2,4})', text)
        if date_match:
            day = int(date_match.group(1))
            month = int(date_match.group(2))
            year = int(date_match.group(3))
            if year < 100:
                year += 2000
            
            try:
                date = datetime(year, month, day)
                logger.info(f"âœ… Ø§Ø³ØªØ®Ø±Ø§Ø¬ ØªØ§Ø±ÙŠØ® Ø±Ù‚Ù…ÙŠ: {date.strftime('%Y-%m-%d')}")
                
                # Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„ÙˆÙ‚Øª
                time_tuple = self._extract_time(text)
                if time_tuple:
                    date = date.replace(hour=time_tuple[0], minute=time_tuple[1])
                else:
                    date = date.replace(hour=9, minute=0)
                
                return date
            except ValueError:
                logger.warning(f"ØªØ§Ø±ÙŠØ® ØºÙŠØ± ØµØ§Ù„Ø­: {day}/{month}/{year}")
                pass
        
        # ==========================================
        # Ø«Ø§Ù†ÙŠØ§Ù‹: Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† "Ø¨Ø¹Ø¯ X Ø¯Ù‚ÙŠÙ‚Ø©/Ø³Ø§Ø¹Ø©"
        # ==========================================
        
        # Ù†Ù…Ø· Ø¹Ø±Ø¨ÙŠ: "Ø¨Ø¹Ø¯ X Ø¯Ù‚ÙŠÙ‚Ø©/Ø³Ø§Ø¹Ø©/ÙŠÙˆÙ…"
        # âœ… FIX: Ø¯Ø¹Ù… "Ø¨Ø¹Ø¯ Ø³Ø§Ø¹Ø©" Ø¨Ø¯ÙˆÙ† Ø±Ù‚Ù…
        
        # Ø£ÙˆÙ„Ø§Ù‹: Ø§Ù„ØµÙŠØº Ø§Ù„Ø®Ø§ØµØ© Ø¨Ø¯ÙˆÙ† Ø£Ø±Ù‚Ø§Ù…
        special_patterns = {
            r'Ø¨Ø¹Ø¯\s+Ø³Ø§Ø¹Ø©(?!\d)': timedelta(hours=1),
            r'Ø¨Ø¹Ø¯\s+Ø³Ø§Ø¹ØªÙŠÙ†': timedelta(hours=2),
            r'Ø¨Ø¹Ø¯\s+Ø¯Ù‚ÙŠÙ‚Ø©(?!\d)': timedelta(minutes=1),
            r'Ø¨Ø¹Ø¯\s+Ø¯Ù‚ÙŠÙ‚ØªÙŠÙ†': timedelta(minutes=2),
            r'Ø¨Ø¹Ø¯\s+ÙŠÙˆÙ…(?!\d)': timedelta(days=1),
            r'Ø¨Ø¹Ø¯\s+ÙŠÙˆÙ…ÙŠÙ†': timedelta(days=2),
        }
        
        for pattern, delta in special_patterns.items():
            if re.search(pattern, text_lower):
                return now + delta
        
        # Ø«Ø§Ù†ÙŠØ§Ù‹: Ø§Ù„ØµÙŠØºØ© Ø§Ù„Ø¹Ø§Ø¯ÙŠØ© Ø¨Ø§Ù„Ø£Ø±Ù‚Ø§Ù…
        after_pattern = re.search(r'Ø¨Ø¹Ø¯\s+(\d+)\s*(Ø¯Ù‚ÙŠÙ‚Ø©|Ø¯Ù‚Ø§Ø¦Ù‚|Ø³Ø§Ø¹Ø©|Ø³Ø§Ø¹Ø§Øª|ÙŠÙˆÙ…|Ø£ÙŠØ§Ù…)', text_lower)
        if after_pattern:
            number = int(after_pattern.group(1))
            unit = after_pattern.group(2)
            
            if 'Ø¯Ù‚ÙŠÙ‚Ø©' in unit or 'Ø¯Ù‚Ø§Ø¦Ù‚' in unit:
                return now + timedelta(minutes=number)
            elif 'Ø³Ø§Ø¹Ø©' in unit or 'Ø³Ø§Ø¹Ø§Øª' in unit:
                return now + timedelta(hours=number)
            elif 'ÙŠÙˆÙ…' in unit or 'Ø£ÙŠØ§Ù…' in unit:
                return now + timedelta(days=number)
        
        # Ù†Ù…Ø· ÙØ±Ù†Ø³ÙŠ: "dans X minutes/heures"
        # âœ… FIX: Ø¯Ø¹Ù… "dans une heure"
        
        french_special = {
            r'dans\s+une\s+heure': timedelta(hours=1),
            r'dans\s+deux\s+heures': timedelta(hours=2),
            r'dans\s+une\s+minute': timedelta(minutes=1),
            r'dans\s+un\s+jour': timedelta(days=1),
            r'dans\s+deux\s+jours': timedelta(days=2),
        }
        
        for pattern, delta in french_special.items():
            if re.search(pattern, text_lower):
                return now + delta
        
        dans_pattern = re.search(r'dans\s+(\d+)\s*(minute|minutes|heure|heures|jour|jours)', text_lower)
        if dans_pattern:
            number = int(dans_pattern.group(1))
            unit = dans_pattern.group(2)
            
            if 'minute' in unit:
                return now + timedelta(minutes=number)
            elif 'heure' in unit:
                return now + timedelta(hours=number)
            elif 'jour' in unit:
                return now + timedelta(days=number)
        
        # Ù†Ù…Ø· Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ: "in X minutes/hours"
        # âœ… FIX: Ø¯Ø¹Ù… "in an hour"
        
        english_special = {
            r'in\s+an?\s+hour': timedelta(hours=1),
            r'in\s+two\s+hours': timedelta(hours=2),
            r'in\s+an?\s+minute': timedelta(minutes=1),
            r'in\s+an?\s+day': timedelta(days=1),
            r'in\s+two\s+days': timedelta(days=2),
        }
        
        for pattern, delta in english_special.items():
            if re.search(pattern, text_lower):
                return now + delta
        
        in_pattern = re.search(r'in\s+(\d+)\s*(minute|minutes|hour|hours|day|days)', text_lower)
        if in_pattern:
            number = int(in_pattern.group(1))
            unit = in_pattern.group(2)
            
            if 'minute' in unit:
                return now + timedelta(minutes=number)
            elif 'hour' in unit:
                return now + timedelta(hours=number)
            elif 'day' in unit:
                return now + timedelta(days=number)
        
        # ==========================================
        # Ø«Ø§Ù„Ø«Ø§Ù‹: Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…ÙØªØ§Ø­ÙŠØ© (Ø§Ù„ÙŠÙˆÙ…ØŒ ØºØ¯Ø§Ù‹ØŒ Ø¥Ù„Ø®)
        # ==========================================
        
        date = None
        
        # Ø¹Ø±Ø¨ÙŠ
        if language == 'ar' or any(word in text_lower for word in ['Ø§Ù„ÙŠÙˆÙ…', 'ØºØ¯Ø§', 'ØºØ¯Ø§Ù‹']):
            if 'Ø§Ù„ÙŠÙˆÙ…' in text_lower:
                date = now
            elif 'ØºØ¯Ø§' in text_lower or 'ØºØ¯Ø§Ù‹' in text_lower:
                date = now + timedelta(days=1)
            elif 'Ø¨Ø¹Ø¯ ØºØ¯' in text_lower:
                date = now + timedelta(days=2)
            elif 'Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ Ø§Ù„Ù‚Ø§Ø¯Ù…' in text_lower or 'Ø§Ù„Ø§Ø³Ø¨ÙˆØ¹ Ø§Ù„Ù‚Ø§Ø¯Ù…' in text_lower:
                date = now + timedelta(weeks=1)
        
        # ÙØ±Ù†Ø³ÙŠ
        if not date and (language == 'fr' or "aujourd'hui" in text_lower or 'demain' in text_lower):
            if "aujourd'hui" in text_lower or 'aujourdhui' in text_lower:
                date = now
            elif 'demain' in text_lower:
                date = now + timedelta(days=1)
            elif 'aprÃ¨s-demain' in text_lower or 'apres-demain' in text_lower:
                date = now + timedelta(days=2)
        
        # Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ
        if not date and (language == 'en' or 'today' in text_lower or 'tomorrow' in text_lower):
            if 'today' in text_lower:
                date = now
            elif 'tomorrow' in text_lower:
                date = now + timedelta(days=1)
            elif 'day after tomorrow' in text_lower:
                date = now + timedelta(days=2)
        
        # Ø£ÙŠØ§Ù… Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹
        if not date:
            days_map_ar = {
                'Ø§Ù„Ø³Ø¨Øª': 5, 'Ø§Ù„Ø£Ø­Ø¯': 6, 'Ø§Ù„Ø§Ø«Ù†ÙŠÙ†': 0,
                'Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡': 1, 'Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡': 2, 'Ø§Ù„Ø®Ù…ÙŠØ³': 3, 'Ø§Ù„Ø¬Ù…Ø¹Ø©': 4
            }
            days_map_fr = {
                'lundi': 0, 'mardi': 1, 'mercredi': 2,
                'jeudi': 3, 'vendredi': 4, 'samedi': 5, 'dimanche': 6
            }
            days_map_en = {
                'monday': 0, 'tuesday': 1, 'wednesday': 2,
                'thursday': 3, 'friday': 4, 'saturday': 5, 'sunday': 6
            }
            
            for day_name, day_num in {**days_map_ar, **days_map_fr, **days_map_en}.items():
                if day_name in text_lower:
                    days_ahead = (day_num - now.weekday()) % 7
                    if days_ahead == 0:
                        days_ahead = 7
                    date = now + timedelta(days=days_ahead)
                    break
        
        # Ø¥Ø°Ø§ Ù„Ù… ÙŠÙØ¹Ø«Ø± Ø¹Ù„Ù‰ ØªØ§Ø±ÙŠØ®ØŒ Ø§Ø³ØªØ®Ø¯Ù… ØºØ¯Ø§Ù‹ ÙƒØ§ÙØªØ±Ø§Ø¶ÙŠ
        if not date:
            date = now + timedelta(days=1)
            logger.warning("Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ØªØ§Ø±ÙŠØ® ÙˆØ§Ø¶Ø­ - Ø§Ø³ØªØ®Ø¯Ø§Ù… ØºØ¯Ø§Ù‹ ÙƒØ§ÙØªØ±Ø§Ø¶ÙŠ")
        
        # ==========================================
        # Ø£Ø®ÙŠØ±Ø§Ù‹: Ø¯Ù…Ø¬ Ø§Ù„ØªØ§Ø±ÙŠØ® Ù…Ø¹ Ø§Ù„ÙˆÙ‚Øª
        # ==========================================
        
        time_tuple = self._extract_time(text)
        
        if time_tuple:
            date = date.replace(hour=time_tuple[0], minute=time_tuple[1], second=0, microsecond=0)
        else:
            # ÙˆÙ‚Øª Ø§ÙØªØ±Ø§Ø¶ÙŠ 9 ØµØ¨Ø§Ø­Ø§Ù‹
            date = date.replace(hour=9, minute=0, second=0, microsecond=0)
        
        return date
    
    def _extract_time(self, text: str) -> Optional[Tuple[int, int]]:
        """Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„ÙˆÙ‚Øª Ù…Ù† Ø§Ù„Ù†Øµ - Ù…Ø­Ø³Ù‘Ù† Ù„Ù„ØµÙŠØºØ© Ø§Ù„ÙØ±Ù†Ø³ÙŠØ© âœ…"""
        # âœ… Ù†Ù…Ø· Ø¬Ø¯ÙŠØ¯: XXhXX (ÙØ±Ù†Ø³ÙŠ) - Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ©!
        french_time = re.search(r'(\d{1,2})h(\d{2})', text.lower())
        if french_time:
            hour = int(french_time.group(1))
            minute = int(french_time.group(2))
            if 0 <= hour <= 23 and 0 <= minute <= 59:
                return (hour, minute)
        
        # Ù†Ù…Ø· XX:XX
        time_pattern = re.search(r'(\d{1,2})[:](\d{2})', text)
        if time_pattern:
            hour = int(time_pattern.group(1))
            minute = int(time_pattern.group(2))
            if 0 <= hour <= 23 and 0 <= minute <= 59:
                return (hour, minute)
        
        # âœ… Ù†Ù…Ø· Ø¬Ø¯ÙŠØ¯: XXh (ÙØ±Ù†Ø³ÙŠ Ø¨Ø¯ÙˆÙ† Ø¯Ù‚Ø§Ø¦Ù‚)
        french_hour_only = re.search(r'(\d{1,2})h(?!\d)', text.lower())
        if french_hour_only:
            hour = int(french_hour_only.group(1))
            if 0 <= hour <= 23:
                return (hour, 0)
        
        # Ù†Ù…Ø· "Ø§Ù„Ø³Ø§Ø¹Ø© X" Ø£Ùˆ "X ØµØ¨Ø§Ø­Ø§Ù‹" Ø£Ùˆ "X Ù…Ø³Ø§Ø¡Ù‹"
        hour_pattern = re.search(r'(\d{1,2})\s*(ØµØ¨Ø§Ø­Ø§|ØµØ¨Ø§Ø­Ø§Ù‹|Ù…Ø³Ø§Ø¡|Ù…Ø³Ø§Ø¡Ù‹|am|pm)', text.lower())
        if hour_pattern:
            hour = int(hour_pattern.group(1))
            period = hour_pattern.group(2)
            
            if period:
                if period in ['Ù…Ø³Ø§Ø¡', 'Ù…Ø³Ø§Ø¡Ù‹', 'pm'] and hour < 12:
                    hour += 12
                elif period in ['ØµØ¨Ø§Ø­Ø§', 'ØµØ¨Ø§Ø­Ø§Ù‹', 'am'] and hour == 12:
                    hour = 0
                elif period == 'pm' and hour == 12:
                    hour = 12
            
            if 0 <= hour <= 23:
                return (hour, 0)
        
        return None
    
    def _extract_title_and_description(self, message: str, language: str) -> Tuple[str, str]:
        """Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø¹Ù†ÙˆØ§Ù† Ù…Ø®ØªØµØ± ÙˆÙˆØµÙ Ù…Ù† Ø§Ù„Ø±Ø³Ø§Ù„Ø©"""
        
        # Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ø²Ù…Ù†ÙŠØ© Ø§Ù„ØªÙŠ ÙŠØ¬Ø¨ Ø­Ø°ÙÙ‡Ø§ Ù…Ù† Ø§Ù„Ø¹Ù†ÙˆØ§Ù†
        time_keywords = {
            'ar': [
                'Ø§Ù„ÙŠÙˆÙ…', 'ØºØ¯Ø§Ù‹', 'ØºØ¯Ø§', 'Ø¨Ø¹Ø¯', 'ØºØ¯', 'Ø£Ù…Ø³', 'Ø§Ù„Ø³Ø§Ø¹Ø©', 'Ø¹Ù„Ù‰', 'ÙÙŠ',
                'ÙŠÙˆÙ…', 'Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹', 'Ø§Ù„Ù‚Ø§Ø¯Ù…', 'Ø¯Ù‚ÙŠÙ‚Ø©', 'Ø¯Ù‚Ø§Ø¦Ù‚', 'Ø³Ø§Ø¹Ø©', 'Ø³Ø§Ø¹Ø§Øª',
                # Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ø´Ù‡ÙˆØ± Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø§Ù„ÙØµØ­Ù‰
                'ÙŠÙ†Ø§ÙŠØ±', 'ÙØ¨Ø±Ø§ÙŠØ±', 'Ù…Ø§Ø±Ø³', 'Ø£Ø¨Ø±ÙŠÙ„', 'Ù…Ø§ÙŠÙˆ', 'ÙŠÙˆÙ†ÙŠÙˆ',
                'ÙŠÙˆÙ„ÙŠÙˆ', 'Ø£ØºØ³Ø·Ø³', 'Ø³Ø¨ØªÙ…Ø¨Ø±', 'Ø£ÙƒØªÙˆØ¨Ø±', 'Ù†ÙˆÙÙ…Ø¨Ø±', 'Ø¯ÙŠØ³Ù…Ø¨Ø±',
                # Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ø´Ù‡ÙˆØ± Ø§Ù„ØªÙˆÙ†Ø³ÙŠØ©/Ø§Ù„Ù…ØºØ§Ø±Ø¨ÙŠØ©
                'Ø¬Ø§Ù†ÙÙŠ', 'ÙÙŠÙØ±ÙŠ', 'Ø£ÙØ±ÙŠÙ„', 'Ù…Ø§ÙŠ', 'Ø¬ÙˆØ§Ù†', 'Ø¬ÙˆÙŠÙ„ÙŠØ©', 
                'Ø£ÙˆØª', 'Ø´ØªÙ†Ø¨Ø±', 'ÙƒØªÙˆØ¨Ø±', 'Ù†ÙˆÙ†Ø¨Ø±', 'Ø¯Ø¬Ù†Ø¨Ø±',
                # Ø£ÙŠØ§Ù… Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹
                'Ø§Ù„Ø³Ø¨Øª', 'Ø§Ù„Ø£Ø­Ø¯', 'Ø§Ù„Ø§Ø«Ù†ÙŠÙ†', 'Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡', 'Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡', 'Ø§Ù„Ø®Ù…ÙŠØ³', 'Ø§Ù„Ø¬Ù…Ø¹Ø©',
                # ÙƒÙ„Ù…Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©
                'Ù„Ø¯ÙŠ', 'Ø¹Ù†Ø¯ÙŠ'
            ],
            'fr': [
                "aujourd'hui", 'aujourdhui', 'demain', 'aprÃ¨s-demain', 'apres-demain',
                'Ã ', 'dans', 'le', 'la', 'heure', 'minute', 'jour',
                'janvier', 'fÃ©vrier', 'fevrier', 'mars', 'avril', 'mai', 'juin',
                'juillet', 'aoÃ»t', 'aout', 'septembre', 'octobre', 'novembre', 'dÃ©cembre', 'decembre',
                'lundi', 'mardi', 'mercredi', 'jeudi', 'vendredi', 'samedi', 'dimanche',
                "j'ai"
            ],
            'en': [
                'today', 'tomorrow', 'at', 'on', 'in', 'next', 'hour', 'minute', 'day',
                'january', 'february', 'march', 'april', 'may', 'june',
                'july', 'august', 'september', 'october', 'november', 'december',
                'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday',
                'i', 'have'
            ]
        }
        
        # ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù„ØºØ© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
        detected_lang = self.detect_language(message)
        keywords_to_remove = time_keywords.get(detected_lang, time_keywords.get(language, []))
        
        # ØªÙ‚Ø³ÙŠÙ… Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¥Ù„Ù‰ ÙƒÙ„Ù…Ø§Øª
        words = message.split()
        title_words = []
        
        for word in words:
            word_clean = word.lower().strip('.,;:!?')
            
            # ØªØ®Ø·ÙŠ Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ø²Ù…Ù†ÙŠØ©
            if word_clean in keywords_to_remove:
                continue
            
            # ØªØ®Ø·ÙŠ Ø§Ù„ØªÙˆØ§Ø±ÙŠØ®
            if re.match(r'\d+[:/\-]\d+', word):
                continue
            
            # ØªØ®Ø·ÙŠ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ù…ÙØ±Ø¯Ø©
            if word.isdigit() and len(word) <= 4:
                continue
            
            # ØªØ®Ø·ÙŠ Ø§Ù„Ø³Ù†ÙˆØ§Øª
            if re.match(r'^(19|20)\d{2}$', word):
                continue
            
            title_words.append(word)
            
            # âœ… ØªÙ… Ø¥Ø²Ø§Ù„Ø© Ø­Ø¯ Ø§Ù„ÙƒÙ„Ù…Ø§Øª - Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ÙƒØ§Ù…Ù„ Ø³ÙŠØ¸Ù‡Ø±
        
        # Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†
        title = ' '.join(title_words)
        
        # Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø¹Ù†ÙˆØ§Ù† ÙØ§Ø±ØºØ§Ù‹ Ø£Ùˆ Ù‚ØµÙŠØ±Ø§Ù‹ Ø¬Ø¯Ø§Ù‹
        if len(title) < 3:
            title = message[:50].strip()
        
        # ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†
        title = ' '.join(title.split())
        
        # Ø§Ù„ÙˆØµÙ = Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„ÙƒØ§Ù…Ù„Ø©
        description = message if len(message) <= 200 else message[:200] + "..."
        
        logger.info(f"ğŸ“ Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ø³ØªØ®Ø±Ø¬: '{title}'")
        
        return title, description
    
    def _extract_date_from_query(self, message: str, language: str) -> Optional[datetime]:
        """
        Ø§Ø³ØªØ®Ø±Ø§Ø¬ ØªØ§Ø±ÙŠØ® Ù…Ù† Ø§Ø³ØªÙØ³Ø§Ø± Ø¹Ø±Ø¶ Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯
        (Ù…Ø«Ù„: "Ù…ÙˆØ§Ø¹ÙŠØ¯ÙŠ ÙŠÙˆÙ… 25 Ù…Ø§Ø±Ø³ 2027")
        """
        message_lower = message.lower()
        now = datetime.now()
        
        # Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ø´Ù‡ÙˆØ± (Ù…Ø¹ Ø¯Ø¹Ù… Ø§Ù„Ù„Ù‡Ø¬Ø© Ø§Ù„ØªÙˆÙ†Ø³ÙŠØ©)
        month_names_ar = {
            'ÙŠÙ†Ø§ÙŠØ±': 1, 'Ø¬Ø§Ù†ÙÙŠ': 1,
            'ÙØ¨Ø±Ø§ÙŠØ±': 2, 'ÙÙŠÙØ±ÙŠ': 2,
            'Ù…Ø§Ø±Ø³': 3,
            'Ø£Ø¨Ø±ÙŠÙ„': 4, 'Ø£ÙØ±ÙŠÙ„': 4,
            'Ù…Ø§ÙŠÙˆ': 5, 'Ù…Ø§ÙŠ': 5,
            'ÙŠÙˆÙ†ÙŠÙˆ': 6, 'Ø¬ÙˆØ§Ù†': 6,
            'ÙŠÙˆÙ„ÙŠÙˆ': 7, 'Ø¬ÙˆÙŠÙ„ÙŠØ©': 7,
            'Ø£ØºØ³Ø·Ø³': 8, 'Ø£ÙˆØª': 8,
            'Ø³Ø¨ØªÙ…Ø¨Ø±': 9, 'Ø´ØªÙ†Ø¨Ø±': 9,
            'Ø£ÙƒØªÙˆØ¨Ø±': 10, 'ÙƒØªÙˆØ¨Ø±': 10,
            'Ù†ÙˆÙÙ…Ø¨Ø±': 11, 'Ù†ÙˆÙ†Ø¨Ø±': 11,
            'Ø¯ÙŠØ³Ù…Ø¨Ø±': 12, 'Ø¯Ø¬Ù†Ø¨Ø±': 12
        }
        
        month_names_fr = {
            'janvier': 1, 'fÃ©vrier': 2, 'fevrier': 2, 'mars': 3, 'avril': 4,
            'mai': 5, 'juin': 6, 'juillet': 7, 'aoÃ»t': 8, 'aout': 8,
            'septembre': 9, 'octobre': 10, 'novembre': 11, 'dÃ©cembre': 12, 'decembre': 12
        }
        
        month_names_en = {
            'january': 1, 'jan': 1, 'february': 2, 'feb': 2, 'march': 3, 'mar': 3,
            'april': 4, 'apr': 4, 'may': 5, 'june': 6, 'jun': 6,
            'july': 7, 'jul': 7, 'august': 8, 'aug': 8,
            'september': 9, 'sep': 9, 'october': 10, 'oct': 10,
            'november': 11, 'nov': 11, 'december': 12, 'dec': 12
        }
        
        all_months = {**month_names_ar, **month_names_fr, **month_names_en}
        
        # Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ù†Ù…Ø·: "DD Ø§Ø³Ù…_Ø§Ù„Ø´Ù‡Ø± YYYY"
        for month_name, month_num in all_months.items():
            pattern = rf'(\d{{1,2}})\s+{month_name}(?:\s+(\d{{4}}))?'
            match = re.search(pattern, message_lower)
            if match:
                day = int(match.group(1))
                year = int(match.group(2)) if match.group(2) else now.year
                
                try:
                    date = datetime(year, month_num, day)
                    logger.info(f"âœ… Ø§Ø³ØªØ®Ø±Ø§Ø¬ ØªØ§Ø±ÙŠØ® Ù…Ù† Ø§Ø³ØªÙØ³Ø§Ø±: {date.strftime('%Y-%m-%d')}")
                    return date
                except ValueError:
                    pass
        
        # Ù†Ù…Ø· DD/MM/YYYY
        date_match = re.search(r'(\d{1,2})[/-](\d{1,2})[/-](\d{2,4})', message)
        if date_match:
            day = int(date_match.group(1))
            month = int(date_match.group(2))
            year = int(date_match.group(3))
            if year < 100:
                year += 2000
            
            try:
                date = datetime(year, month, day)
                logger.info(f"âœ… Ø§Ø³ØªØ®Ø±Ø§Ø¬ ØªØ§Ø±ÙŠØ® Ø±Ù‚Ù…ÙŠ Ù…Ù† Ø§Ø³ØªÙØ³Ø§Ø±: {date.strftime('%Y-%m-%d')}")
                return date
            except ValueError:
                pass
        
        # Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…ÙØªØ§Ø­ÙŠØ©
        if 'Ø§Ù„ÙŠÙˆÙ…' in message_lower or "aujourd'hui" in message_lower or 'today' in message_lower:
            return now
        elif 'ØºØ¯Ø§' in message_lower or 'ØºØ¯Ø§Ù‹' in message_lower or 'demain' in message_lower or 'tomorrow' in message_lower:
            return now + timedelta(days=1)
        elif 'Ø¨Ø¹Ø¯ ØºØ¯' in message_lower or 'aprÃ¨s-demain' in message_lower or 'day after tomorrow' in message_lower:
            return now + timedelta(days=2)
        
        # Ø£ÙŠØ§Ù… Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹
        days_map = {
            'Ø§Ù„Ø³Ø¨Øª': 5, 'Ø§Ù„Ø£Ø­Ø¯': 6, 'Ø§Ù„Ø§Ø«Ù†ÙŠÙ†': 0, 'Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡': 1,
            'Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡': 2, 'Ø§Ù„Ø®Ù…ÙŠØ³': 3, 'Ø§Ù„Ø¬Ù…Ø¹Ø©': 4,
            'lundi': 0, 'mardi': 1, 'mercredi': 2, 'jeudi': 3,
            'vendredi': 4, 'samedi': 5, 'dimanche': 6,
            'monday': 0, 'tuesday': 1, 'wednesday': 2, 'thursday': 3,
            'friday': 4, 'saturday': 5, 'sunday': 6
        }
        
        for day_name, day_num in days_map.items():
            if day_name in message_lower:
                days_ahead = (day_num - now.weekday()) % 7
                if days_ahead == 0:
                    days_ahead = 7
                return now + timedelta(days=days_ahead)
        
        # Ù„Ù… ÙŠÙØ¹Ø«Ø± Ø¹Ù„Ù‰ ØªØ§Ø±ÙŠØ®
        return None
    
    def process_message(self, user_id: int, message: str) -> str:
        """Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©"""
        # ÙƒØ´Ù Ø§Ù„Ù„ØºØ©
        language = self.detect_language(message)
        
        # ØªØµÙ†ÙŠÙ Ø§Ù„Ù†ÙŠØ©
        intent = self.classify_intent(message)
        
        response = ""
        
        # Ù…Ø¹Ø§Ù„Ø¬Ø© Ø­Ø³Ø¨ Ø§Ù„Ù†ÙŠØ©
        if intent == 'add_appointment':
            # Ø§Ø³ØªØ®Ø±Ø§Ø¬ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…ÙˆØ¹Ø¯
            date_time = self.extract_datetime(message, language)
            
            # Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø¹Ù†ÙˆØ§Ù† Ù…Ø®ØªØµØ± ÙˆÙˆØµÙ
            title, description = self._extract_title_and_description(message, language)
            
            # Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…ÙˆØ¹Ø¯
            appointment_id = self.db.add_appointment(
                user_id, 
                title,
                description,
                date_time
            )
            
            # Ø±Ø¯ Ø¨Ø«Ù„Ø§Ø« Ù„ØºØ§Øª
            response = f"""âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ¹Ø¯ Ø¨Ù†Ø¬Ø§Ø­! 
âœ… Rendez-vous ajoutÃ© avec succÃ¨s!
âœ… Appointment added successfully!

ğŸ“‹ Ø±Ù‚Ù… Ø§Ù„Ù…ÙˆØ¹Ø¯ | NumÃ©ro | ID: {appointment_id}
ğŸ“… Ø§Ù„ØªØ§Ø±ÙŠØ® | Date: {date_time.strftime('%Y-%m-%d %H:%M')}"""
        
        elif intent == 'check_specific_day':
            # Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„ØªØ§Ø±ÙŠØ® Ù…Ù† Ø§Ù„Ø§Ø³ØªÙØ³Ø§Ø±
            target_date = self._extract_date_from_query(message, language)
            
            if target_date:
                # ØªØ³Ù…ÙŠØ§Øª Ø­Ø³Ø¨ Ø§Ù„ØªØ§Ø±ÙŠØ®
                now = datetime.now()
                if target_date.date() == now.date():
                    day_label_ar = "Ø§Ù„ÙŠÙˆÙ…"
                    day_label_fr = "Aujourd'hui"
                    day_label_en = "Today"
                elif target_date.date() == (now + timedelta(days=1)).date():
                    day_label_ar = "ØºØ¯Ø§Ù‹"
                    day_label_fr = "Demain"
                    day_label_en = "Tomorrow"
                else:
                    day_label_ar = target_date.strftime('%d/%m/%Y')
                    day_label_fr = target_date.strftime('%d/%m/%Y')
                    day_label_en = target_date.strftime('%d/%m/%Y')
            else:
                # Ø§ÙØªØ±Ø§Ø¶ÙŠ: Ø§Ù„ÙŠÙˆÙ…
                target_date = datetime.now()
                day_label_ar = "Ø§Ù„ÙŠÙˆÙ…"
                day_label_fr = "Aujourd'hui"
                day_label_en = "Today"
            
            # ØªØ­Ø¯ÙŠØ¯ Ø¨Ø¯Ø§ÙŠØ© ÙˆÙ†Ù‡Ø§ÙŠØ© Ø§Ù„ÙŠÙˆÙ…
            day_start = target_date.replace(hour=0, minute=0, second=0, microsecond=0)
            day_end = target_date.replace(hour=23, minute=59, second=59, microsecond=0)
            
            # Ø¬Ù„Ø¨ Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯
            appointments = self.db.get_appointments(
                user_id,
                day_start.strftime('%Y-%m-%d %H:%M:%S'),
                day_end.strftime('%Y-%m-%d %H:%M:%S')
            )
            
            if not appointments:
                response = f"""ğŸ“… **Ù…ÙˆØ§Ø¹ÙŠØ¯Ùƒ {day_label_ar}**
**{day_start.strftime('%d/%m/%Y')}**

âœ¨ Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ÙˆØ§Ø¹ÙŠØ¯
âœ¨ Aucun rendez-vous
âœ¨ No appointments"""
            else:
                response = f"""ğŸ“… **Ù…ÙˆØ§Ø¹ÙŠØ¯Ùƒ {day_label_ar}**
**{day_start.strftime('%d/%m/%Y')}**

"""
                for apt in appointments:
                    # ØªÙ†Ø¸ÙŠÙ microseconds
                    apt_time_str = apt['date_time']
                    if '.' in apt_time_str:
                        apt_time_str = apt_time_str.split('.')[0]
                    
                    try:
                        apt_time = datetime.strptime(apt_time_str, '%Y-%m-%d %H:%M:%S')
                        priority_emoji = "ğŸ”´" if apt['priority'] == 1 else "ğŸŸ¡" if apt['priority'] == 2 else "ğŸŸ¢"
                        
                        response += f"{priority_emoji} **{apt_time.strftime('%H:%M')}** - {apt['title']}\n"
                        if apt['description'] and apt['description'] != apt['title']:
                            response += f"   ğŸ“ {apt['description'][:50]}...\n"
                        response += "\n"
                    except Exception as e:
                        logger.error(f"Ø®Ø·Ø£ ÙÙŠ parsing Ø§Ù„ØªØ§Ø±ÙŠØ®: {apt_time_str} - {e}")
                        continue
        
        elif intent == 'list_appointments':
            appointments = self.db.get_appointments(user_id)
            
            if not appointments:
                response = """ğŸ“­ Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ÙˆØ§Ø¹ÙŠØ¯ Ø­Ø§Ù„ÙŠØ§Ù‹
ğŸ“­ Aucun rendez-vous pour le moment
ğŸ“­ No appointments at the moment"""
            else:
                response = """ğŸ“‹ **Ù…ÙˆØ§Ø¹ÙŠØ¯Ùƒ | Vos rendez-vous | Your appointments:**

"""
                for apt in appointments:
                    # ØªÙ†Ø¸ÙŠÙ microseconds
                    apt_time_str = apt['date_time']
                    if '.' in apt_time_str:
                        apt_time_str = apt_time_str.split('.')[0]
                    
                    try:
                        priority_emoji = "ğŸ”´" if apt['priority'] == 1 else "ğŸŸ¡" if apt['priority'] == 2 else "ğŸŸ¢"
                        apt_date = datetime.strptime(apt_time_str, '%Y-%m-%d %H:%M:%S')
                        
                        response += f"{priority_emoji} **{apt['title']}**\n"
                        response += f"ğŸ“… {apt_date.strftime('%d/%m/%Y %H:%M')}\n"
                        if apt['description'] and apt['description'] != apt['title']:
                            response += f"ğŸ“ {apt['description'][:50]}...\n"
                        response += "\n"
                    except Exception as e:
                        logger.error(f"Ø®Ø·Ø£ ÙÙŠ parsing Ø§Ù„ØªØ§Ø±ÙŠØ®: {apt_time_str} - {e}")
                        continue
        
        elif intent == 'greeting':
            response = """Ù…Ø±Ø­Ø¨Ø§Ù‹! ğŸ‘‹ ÙƒÙŠÙ ÙŠÙ…ÙƒÙ†Ù†ÙŠ Ù…Ø³Ø§Ø¹Ø¯ØªÙƒØŸ
Bonjour! ğŸ‘‹ Comment puis-je vous aider?
Hello! ğŸ‘‹ How can I help you?"""
        
        elif intent == 'thanks':
            response = """Ø§Ù„Ø¹ÙÙˆ! ğŸ˜Š
De rien! ğŸ˜Š
You're welcome! ğŸ˜Š"""
        
        elif intent == 'help':
            response = """ğŸ¤– **Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© | Aide | Help:**

**Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©:**
- Ø§ÙƒØªØ¨: "Ù…ÙˆØ¹Ø¯ ØºØ¯Ø§Ù‹ Ø§Ù„Ø³Ø§Ø¹Ø© 3"
- "Ù…Ø§ Ù‡ÙŠ Ù…ÙˆØ§Ø¹ÙŠØ¯ÙŠ Ø§Ù„ÙŠÙˆÙ…ØŸ"
- "Ù…ÙˆØ§Ø¹ÙŠØ¯ÙŠ ÙŠÙˆÙ… 25 Ù…Ø§Ø±Ø³ 2027"
- "Ø¹Ø±Ø¶ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯"

**FranÃ§ais:**
- Ã‰crivez: "RDV demain Ã  15h"
- "Mes rendez-vous aujourd'hui"
- "Mes RDV le 25 mars 2027"
- "Afficher tous les RDV"

**English:**
- Write: "Appointment tomorrow at 3pm"
- "My appointments today"
- "My appointments on March 25, 2027"
- "Show all appointments"
"""
        
        else:
            response = """ğŸ¤” Ù„Ù… Ø£ÙÙ‡Ù… Ø·Ù„Ø¨Ùƒ. Ø¬Ø±Ø¨:
"Ù…ÙˆØ¹Ø¯ ØºØ¯Ø§Ù‹ Ø§Ù„Ø³Ø§Ø¹Ø© 3"
"Ù…ÙˆØ§Ø¹ÙŠØ¯ÙŠ Ø§Ù„ÙŠÙˆÙ…"

ğŸ¤” Je n'ai pas compris. Essayez:
"RDV demain Ã  15h"
"Mes RDV aujourd'hui"

ğŸ¤” I didn't understand. Try:
"Appointment tomorrow at 3pm"
"My appointments today"
"""
        
        # ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØªÙØ§Ø¹Ù„
        self.db.log_interaction(user_id, message, response, intent, language)
        import re

        # Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø·Ù„Ø¨ ØªØ°ÙƒÙŠØ± Ù…Ø®ØµØµ
        reminder_patterns = [
            r'Ø°ÙƒØ±Ù†ÙŠ Ù‚Ø¨Ù„ (\d+) Ø¯Ù‚ÙŠÙ‚Ø©',
            r'Ø°ÙƒØ±Ù†ÙŠ Ù‚Ø¨Ù„ (\d+) Ø¯Ù‚Ø§Ø¦Ù‚',
            r'Ø°ÙƒØ±Ù†ÙŠ Ù‚Ø¨Ù„ Ø³Ø§Ø¹Ø©',
            r'Ø°ÙƒØ±Ù†ÙŠ Ù‚Ø¨Ù„ ÙŠÙˆÙ…',
            r'rappelle.moi (\d+) minutes? avant',
            r'remind me (\d+) minutes? before'
        ]

        for pattern in reminder_patterns:
            match = re.search(pattern, message.lower(), re.IGNORECASE)
            if match:
                try:
                    # Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù…Ø¯ÙŠØ± Ø§Ù„ØªØ°ÙƒÙŠØ±Ø§Øª Ø§Ù„Ù…Ø®ØµØµØ©
                    from advanced_features import CustomReminderManager
            
                    # Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¢Ø®Ø± Ù…ÙˆØ¹Ø¯ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
                    cursor.execute('''
                        SELECT id FROM appointments 
                        WHERE user_id = ? 
                        ORDER BY created_at DESC 
                        LIMIT 1
                    ''', (user_id,))
            
                    last_appointment = cursor.fetchone()
            
                    if last_appointment:
                        appointment_id = last_appointment[0]
                
                        # ØªØ­Ø¯ÙŠØ¯ Ø¹Ø¯Ø¯ Ø§Ù„Ø¯Ù‚Ø§Ø¦Ù‚
                        if 'Ø³Ø§Ø¹Ø©' in message or 'hour' in message or 'heure' in message:
                            minutes_before = 60
                        elif 'ÙŠÙˆÙ…' in message or 'day' in message or 'jour' in message:
                            minutes_before = 1440
                        else:
                            minutes_before = int(match.group(1))
                
                    # Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØªØ°ÙƒÙŠØ± Ø§Ù„Ù…Ø®ØµØµ
                        reminder_mgr = CustomReminderManager(self.db_path)
                        reminder_id = reminder_mgr.add_custom_reminder(
                            appointment_id=appointment_id,
                            minutes_before=minutes_before,
                            custom_message=f"ØªØ°ÙƒÙŠØ±: Ù„Ø¯ÙŠÙƒ Ù…ÙˆØ¹Ø¯ Ø¨Ø¹Ø¯ {minutes_before} Ø¯Ù‚ÙŠÙ‚Ø©"
                        )
                
                        return (
                            f"âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØªØ°ÙƒÙŠØ±!\n"
                            f"ğŸ”” Ø³Ø£Ø°ÙƒØ±Ùƒ Ù‚Ø¨Ù„ {minutes_before} Ø¯Ù‚ÙŠÙ‚Ø© Ù…Ù† Ø§Ù„Ù…ÙˆØ¹Ø¯ #{appointment_id}\n\n"
                            f"âœ… Rappel ajoutÃ©!\n"
                            f"ğŸ”” Je vous rappellerai {minutes_before} minutes avant le RDV\n\n"
                            f"âœ… Reminder added!\n"
                            f"ğŸ”” I'll remind you {minutes_before} minutes before the appointment"
                        )
                    else:
                        return (
                            "âš ï¸ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…ÙˆØ¹Ø¯ Ø­Ø¯ÙŠØ« Ù„Ø¥Ø¶Ø§ÙØ© ØªØ°ÙƒÙŠØ± Ù„Ù‡\n"
                            "Ø£Ø¶Ù Ù…ÙˆØ¹Ø¯Ø§Ù‹ Ø£ÙˆÙ„Ø§Ù‹ Ø«Ù… Ø£Ø¶Ù Ø§Ù„ØªØ°ÙƒÙŠØ±\n\n"
                            "âš ï¸ Aucun RDV rÃ©cent\n"
                            "Ajoutez d'abord un RDV\n\n"
                            "âš ï¸ No recent appointment\n"
                            "Add an appointment first"
                        )
                
                except Exception as e:
                    logger.error(f"Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¶Ø§ÙØ© ØªØ°ÙƒÙŠØ± Ù…Ø®ØµØµ: {e}")
                # Ø§Ø³ØªÙ…Ø±Ø§Ø± Ø§Ù„Ø¹Ù…Ù„ Ø¨Ø¯ÙˆÙ† Ø§Ù„Ù…Ø±Ø­Ù„Ø© 2
                    pass

        return response


# Ø§Ø®ØªØ¨Ø§Ø± Ø³Ø±ÙŠØ¹
if __name__ == "__main__":
    print("="*60)
    print("ğŸ§ª Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ÙˆÙƒÙŠÙ„ Ø§Ù„Ø°ÙƒÙŠ - Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©")
    print("="*60)
    
    agent = IntelligentAgent()
    
    test_messages = [
        "Ù„Ø¯ÙŠ Ù…ÙˆØ¹Ø¯ Ù…Ø¹ Ø§Ù„Ø·Ø¨ÙŠØ¨ ÙŠÙˆÙ… 25 Ø£ÙƒØªÙˆØ¨Ø± 2025 Ø§Ù„Ø³Ø§Ø¹Ø© 10:30",
        "Ù…ÙˆØ¹Ø¯ Ù…Ø¹ Ø¬Ø¯ØªÙŠ ÙŠÙˆÙ… 23 Ø¬Ø§Ù†ÙÙŠ 2026 Ø¹Ù„Ù‰ Ø§Ù„Ø³Ø§Ø¹Ø© 16:55",
        "Ø§Ø¬ØªÙ…Ø§Ø¹ Ø¨Ø¹Ø¯ 30 Ø¯Ù‚ÙŠÙ‚Ø©",
        "Ù…ÙˆØ§Ø¹ÙŠØ¯ÙŠ Ø§Ù„ÙŠÙˆÙ…",
        "Ù…ÙˆØ§Ø¹ÙŠØ¯ÙŠ ÙŠÙˆÙ… 25 Ø£ÙƒØªÙˆØ¨Ø± 2025"
    ]
    
    for msg in test_messages:
        print(f"\nğŸ’¬ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: {msg}")
        print("â”€"*60)
        response = agent.process_message(user_id=1, message=msg)
        print(response)
        print()
    
    print("="*60)
    print("âœ… Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù†ØªÙ‡Ù‰!")
    print("="*60)